# Docker Compose configuration for pre-production environment with PostgreSQL, Redis, and all application services.

services:
  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    container_name: spotify-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-admin}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-admin}
      POSTGRES_DB: ${POSTGRES_DB:-spotify}
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U admin -d spotify"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - spotify-network

  # Redis для кэширования и сессий
  redis:
    image: redis:7-alpine
    container_name: spotify-redis
    restart: unless-stopped
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3
    networks:
      - spotify-network

  # Backend API (NestJS)
  api:
    build:
      context: .
      dockerfile: ./apps/api/Dockerfile
      target: development
    container_name: spotify-api
    restart: unless-stopped
    environment:
      NODE_ENV: development
      DATABASE_URL: postgresql://${POSTGRES_USER:-admin}:${POSTGRES_PASSWORD:-admin}@postgres:5432/${POSTGRES_DB:-spotify}
      REDIS_URL: redis://redis:6379
      REDIS_HOST: ${REDIS_HOST:-redis}
      REDIS_PORT: ${REDIS_PORT:-6379}
      WEB_HOST: ${WEB_HOST:-http://localhost:3001}
      PORT: 3000
    ports:
      - "${API_PORT:-3000}:3000"
    volumes:
      - ./apps/api:/app/apps/api
      - ./packages:/app/packages
      - ./apps/api/uploads:/app/apps/api/uploads
      - ./apps/api/public:/app/apps/api/public
      - /app/node_modules
      - /app/apps/api/node_modules
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - spotify-network
    command: pnpm --filter @spotify/api run start:dev

  # Web Player (Next.js)
  web-player:
    build:
      context: .
      dockerfile: ./apps/web-player/Dockerfile
      target: development
    container_name: spotify-web-player
    restart: unless-stopped
    environment:
      NODE_ENV: development
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://localhost:3000}
      PORT: 3001
    ports:
      - "${WEB_PORT:-3001}:3001"
    volumes:
      - ./apps/web-player:/app/apps/web-player
      - ./packages:/app/packages
      - /app/node_modules
      - /app/apps/web-player/node_modules
      - /app/apps/web-player/.next
    depends_on:
      - api
    networks:
      - spotify-network
    command: pnpm --filter @spotify/web-player run dev

  # Web Artists (Next.js)
  web-artists:
    build:
      context: .
      dockerfile: ./apps/web-artists/Dockerfile
      target: development
    container_name: spotify-web-artists
    restart: unless-stopped
    environment:
      NODE_ENV: development
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://localhost:3000}
      PORT: 3002
    ports:
      - "${WEB_ARTISTS_PORT:-3004}:3002"
    volumes:
      - ./apps/web-artists:/app/apps/web-artists
      - ./packages:/app/packages
      - /app/node_modules
      - /app/apps/web-artists/node_modules
      - /app/apps/web-artists/.next
    depends_on:
      - api
    networks:
      - spotify-network
    command: pnpm --filter @spotify/web-artists run dev

  # Admin Panel (Kottster)
  admin:
    build:
      context: .
      dockerfile: ./apps/admin/Dockerfile
      target: development
    container_name: spotify-admin
    restart: unless-stopped
    environment:
      NODE_ENV: development
      DATABASE_URL: postgresql://${POSTGRES_USER:-admin}:${POSTGRES_PASSWORD:-admin}@postgres:5432/${POSTGRES_DB:-spotify}
      PORT: 3002
    ports:
      - "${ADMIN_PORT:-3002}:3002"
    volumes:
      - ./apps/admin:/app/apps/admin
      - ./packages:/app/packages
      - /app/node_modules
      - /app/apps/admin/node_modules
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - spotify-network
    command: pnpm --filter @spotify/admin run dev

  # Mobile App (Expo Development Server)
  mobile:
    build:
      context: .
      dockerfile: ./apps/mobile/Dockerfile
      target: development
    container_name: spotify-mobile
    restart: unless-stopped
    environment:
      NODE_ENV: development
      EXPO_DEVTOOLS_LISTEN_ADDRESS: 0.0.0.0
      REACT_NATIVE_PACKAGER_HOSTNAME: ${MOBILE_HOST:-192.168.1.100}
    ports:
      - "${MOBILE_METRO_PORT:-8081}:8081"      # Metro bundler
      - "${MOBILE_DEVTOOLS_PORT:-19000}:19000" # Expo DevTools
      - "${MOBILE_METRO_UI_PORT:-19001}:19001" # Metro UI
      - "${MOBILE_WEB_PORT:-19006}:19006"      # Expo Web
    volumes:
      - ./apps/mobile:/app/apps/mobile
      - ./packages:/app/packages
      - /app/node_modules
      - /app/apps/mobile/node_modules
      - /app/apps/mobile/.expo
    networks:
      - spotify-network
    command: pnpm --filter @spotify/mobile run start -- --tunnel
    profiles:
      - mobile

  # Desktop App (UI Development Server)
  desktop:
    build:
      context: .
      dockerfile: ./apps/desktop/Dockerfile
      target: development
    container_name: spotify-desktop
    restart: unless-stopped
    environment:
      NODE_ENV: development
    ports:
      - "${DESKTOP_PORT:-1420}:1420"
    volumes:
      - ./apps/desktop:/app/apps/desktop
      - ./packages:/app/packages
      - /app/node_modules
      - /app/apps/desktop/node_modules
    networks:
      - spotify-network
    command: pnpm --filter @spotify/desktop run dev
    profiles:
      - desktop

  # Documentation (Docusaurus)
  docs:
    build:
      context: .
      dockerfile: ./apps/docs/Dockerfile
      target: development
    container_name: spotify-docs
    restart: unless-stopped
    environment:
      NODE_ENV: development
    ports:
      - "${DOCS_PORT:-3003}:3003"
    volumes:
      - ./apps/docs:/app/apps/docs
      - ./package.json:/app/package.json
      - ./pnpm-lock.yaml:/app/pnpm-lock.yaml
      - ./pnpm-workspace.yaml:/app/pnpm-workspace.yaml
      - ./turbo.json:/app/turbo.json
      - /app/node_modules
      - /app/apps/docs/node_modules
      - /app/apps/docs/.docusaurus
      - /app/apps/docs/build
    networks:
      - spotify-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3003"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    profiles:
      - docs

  # Nginx Reverse Proxy (опционально для production-like окружения)
  nginx:
    image: nginx:alpine
    container_name: spotify-nginx
    restart: unless-stopped
    ports:
      - "${NGINX_HTTP_PORT:-80}:80"
      - "${NGINX_HTTPS_PORT:-443}:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
    depends_on:
      - api
      - web-player
      - web-artists
      - admin
    networks:
      - spotify-network
    profiles:
      - production

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local

networks:
  spotify-network:
    driver: bridge
