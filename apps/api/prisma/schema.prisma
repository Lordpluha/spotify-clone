generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id       String @id @default(uuid(7)) @db.Uuid
  username String @unique
  email    String @unique
  password String

  avatar      String?
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt

  sessions    Session[]
  playlists   Playlist[]
  likedTracks Track[]    @relation("UserLikedTracks")

  @@index([email])
  @@index([username])
}

model Session {
  id            String @id @default(uuid(7)) @db.Uuid
  userId        String @db.Uuid
  access_token  String @unique
  refresh_token String @unique

  createdAt DateTime  @default(now())
  expiresAt DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([access_token])
  @@index([refresh_token])
}

model Track {
  id       String  @id @default(uuid(7)) @db.Uuid
  title    String
  audioUrl String // Primary audio file URL
  cover    String?
  artistId String  @db.Uuid

  duration    Int? // Duration in seconds
  releaseDate DateTime?
  lyrics      String?   @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  audioFiles TrackFile[]
  albums     Album[]
  playlists  Playlist[]
  likedBy    User[]      @relation("UserLikedTracks")

  artist Artist @relation(fields: [artistId], references: [id], onDelete: Cascade)

  @@index([artistId])
  @@index([title])
  @@index([releaseDate])
}

model TrackFile {
  id      String  @id @default(uuid(7)) @db.Uuid
  trackId String  @db.Uuid
  format  String // "opus", "ogg", "mp3", "flac"
  bitrate Int // 128, 192, 256, 320
  codec   String? // "opus", "vorbis", "mp3"
  url     String
  size    Int? // File size in bytes

  createdAt DateTime @default(now())

  track Track @relation(fields: [trackId], references: [id], onDelete: Cascade)

  @@unique([trackId, format, bitrate])
  @@index([trackId])
  @@index([format])
}

model Artist {
  id       String @id @default(uuid(7)) @db.Uuid
  username String @unique
  email    String @unique
  password String

  bio             String? @db.Text
  avatar          String?
  backgroundImage String?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  tracks Track[]
  albums Album[]

  @@index([email])
  @@index([username])
}

model Album {
  id          String  @id @default(uuid(7)) @db.Uuid
  title       String
  cover       String?
  artistId    String  @db.Uuid
  description String? @db.Text

  releaseDate DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  tracks Track[]

  artist Artist @relation(fields: [artistId], references: [id], onDelete: Cascade)

  @@index([artistId])
  @@index([title])
  @@index([releaseDate])
}

model Playlist {
  id          String  @id @default(uuid(7)) @db.Uuid
  title       String
  cover       String?
  description String? @db.Text
  isPublic    Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
  userId    String   @db.Uuid

  tracks Track[]

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isPublic])
}
